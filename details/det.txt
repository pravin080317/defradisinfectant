document.addEventListener('DOMContentLoaded', function () {
  var params = new URLSearchParams(window.location.search);
  var p = parseInt(params.get('page'), 10);
  if (!isNaN(p)) currentPage = p;
  var totalPages = Math.ceil(totalItemCount / recordsPerPage);

  function showPage(page) {
    var table = document.getElementById('{{ tableid }}');
    if (!table) return;
    var rows = table.tBodies[0].rows;
    var start = (page - 1) * recordsPerPage;
    var end = start + recordsPerPage;
    for (var i = 0; i < rows.length; i++) {
      rows[i].style.display = i >= start && i < end ? 'table-row' : 'none';
    }
    currentPage = page;
    highlight(page);
  }

  function highlight(page) {
    document.querySelectorAll('#pagination-container li').forEach(function (li) {
      var a = li.querySelector('a');
      if (!a) return;
      var pageNum = parseInt(a.textContent.trim(), 10);
      if (isNaN(pageNum)) return;
      a.href = '?page=' + pageNum;
      if (pageNum === page) {
        li.classList.add('govuk-pagination__item--current');
        a.setAttribute('aria-current', 'page');
      } else {
        li.classList.remove('govuk-pagination__item--current');
        a.removeAttribute('aria-current');
      }
    });
  }

  function navigate(page) {
    if (page < 1 || page > totalPages) return;
    showPage(page);
    history.replaceState(null, '', '?page=' + page);
  }

  document.querySelectorAll('#pagination-container li a').forEach(function (a) {
    a.addEventListener('click', function (e) {
      e.preventDefault();
      var pageNum = parseInt(a.textContent.trim(), 10);
      if (!isNaN(pageNum)) navigate(pageNum);
    });
  });

  var prev = document.querySelector('.govuk-pagination_prev a');
  if (prev) {
    prev.addEventListener('click', function (e) {
      e.preventDefault();
      if (currentPage > 1) navigate(currentPage - 1);
    });
  }

  var next = document.querySelector('.govuk-pagination.next a');
  if (next) {
    next.addEventListener('click', function (e) {
      e.preventDefault();
      if (currentPage < totalPages) navigate(currentPage + 1);
    });
  }

  showPage(currentPage);
});
