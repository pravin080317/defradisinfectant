SELECT 
    -- Portal File Management Info
    pfm.voap_portalfilemanagementid      AS PortalFileManagementId,
    pfm.voap_filename                    AS FileName,
    pfm.statuscodename                  AS FileStatus,
    pfm.voap_errorcode                  AS FileErrorCode,
    pfm.createdon                       AS FileCreatedOn,

    -- Front Door Header Info
    fdh.voa_frontdoorheaderid           AS FrontDoorHeaderId,
    fdh.voa_submissionid               AS SubmissionId,
    fdh.voa_sourcefiletypecodename     AS SourceFileType,
    fdh.voa_isvestibulename            AS IsVestibule,
    fdh.voa_totalfrontdoorrowscount    AS TotalRows,
    fdh.voa_validatedfrontdoorrowcount AS ValidatedRows,
    fdh.voa_unmatchedfrontdoorrowcount AS UnmatchedRows,
    fdh.voa_addressmatchfrontdoorrowcount AS AddressMatchedRows,

    -- Front Door Row Info
    fdr.voa_frontdoorrowid             AS FrontDoorRowId,
    fdr.voa_name                       AS RowName,
    fdr.voa_numberofunmatchedaddresses AS UnmatchedRowCount,
    fdr.voa_arethereunmatchedaddresses AS IsUnmatched,
    fdr.voa_arethereunmatchedaddressesname AS IsUnmatchedName,
    fdr.voa_aretheremanuallymatchedaddresses AS IsManualMatch,
    fdr.voa_aretheremanuallymatchedaddressesname AS IsManualMatchName,

    -- Error Info
    fde.voa_frontdoorerrorid           AS FrontDoorErrorId,
    fde.voa_error                      AS RawErrorCode,
    fde.voa_description               AS RawErrorDescription

FROM dbo.voap_portalfilemanagement pfm

-- Join with front door headers
LEFT JOIN dbo.voa_frontdoorheader fdh
    ON fdh.voa_portalfilemanagementid = pfm.voap_portalfilemanagementid

-- Join with front door rows
LEFT JOIN dbo.voa_frontdoorrow fdr
    ON fdr.voa_frontdoorheaderid = fdh.voa_frontdoorheaderid

-- Join with row-level errors
LEFT JOIN dbo.voa_frontdoorerror fde
    ON fde.voa_frontdoorrowid = fdr.voa_frontdoorrowid

-- Filter only files that are still in processing OR failed OR completed with errors
WHERE pfm.statuscodename IN (
    'Processing',
    'Processing Error',
    'Complete with Address Matching Error'
)

ORDER BY pfm.createdon DESC, fdh.voa_frontdoorheaderid, fdr.voa_frontdoorrowid;
