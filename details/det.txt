Run Book Entry: Application Insights Integration for PA Tracking
Purpose
To capture and analyze user activity and behavior on the Local Authority (LA) Portal built using Power Pages, supporting the Performance Analyst (PA) team with data-driven insights via Azure Application Insights and Power BI.

Implementation Overview
Telemetry is implemented client-side using the Application Insights JavaScript SDK.

A custom content snippet is configured in Power Pages and referenced via the Enable Traffic Analytics feature.

The Application Insights Connection String is securely managed using a Site Setting:
applicationinsights/enabletracking.

Captured Telemetry
Each page view and interaction captures:

User Context
userId: Dataverse contact ID (if logged in), otherwise "Anonymous".

userName: Full name (optional, excluded in production reports).

UserStatus: "LoggedIn" or "Guest".

Council: BAC code from Dataverse (via related account entity).

Session and Page Tracking
sessionId: Custom session ID (UUID), stored in sessionStorage.

pageTitle: Retrieved from document.title.

url: Page URL.

PortalPageLoadTime: ISO timestamp of page load.

loginTime: Time of initial login (captured via trackEvent).

Custom Event
LAPortalTracking: Custom telemetry event with contextual properties:

User ID, Council, Status, Timestamp, and Page.

Technical Highlights
Connection String is used (not just InstrumentationKey).

Cookies are disabled (disableCookiesUsage: true) to prevent ai_user and ai_session.

Session management is handled manually using sessionStorage.

Telemetry Initializers enrich telemetry data before submission.

Page tracking logic includes a session-aware mechanism to prevent double-counting across page visits.

Deployment Notes
JavaScript snippet is placed in a Content Snippet (used via Traffic Analytics).

Site Setting holds the App Insights connection string:

Key: applicationinsights/enabletracking

PROD Deployment:

Requires manual RFC to update site settings (3-day notice).

RFC should include a rollback plan (reverting the site setting to previous value).

Data Access and Reporting
KQL queries in Azure Monitor used to analyze telemetry in real-time.

Power BI is used for visualizing:

Page completion flows

Session-level activity

Performance benchmarks per council/user.

Known Limitations and Risks
InstrumentationKey is part of the Connection String (Microsoft’s SDK design).

Does not allow reading/storing/altering data but can be used to spam telemetry.

Spam mitigation:

Alerts for high ingestion volume configured in Azure Monitor.

Telemetry filtering in Power BI dashboards (via custom dimensions).

Session continuity is managed per-tab; session reuse across tabs or browsers is not guaranteed.

Planned Enhancements
Finalize download tracking for schedule files (PDF/XLS), including:

Filename, time, file type, and council.

Implement session-aware completion tracking (e.g., page journey tracking).

Extend telemetry to other portal areas beyond dashboard (e.g., bulk report submissions).

Conduct a POC for hybrid telemetry ingestion using:

Reverse proxy (via Azure API Management)

Server-side relay (via Azure Function)

Evaluate and migrate to Entra ID–based telemetry ingestion (IK support ends March 2025).
