WITH FileExtensions AS (
    SELECT
        pfm.voap_filename AS [FileName],
        pfm.voap_filesizeinkb AS [FileSizeKB],
        pfm.createdon AS [DateUploaded],
        pfm.voap_loggedinuser AS [UserName],
        pfm.voap_billingauthority AS [BANumber],
        RIGHT(pfm.voap_filename, CHARINDEX('.', REVERSE(pfm.voap_filename)) - 1) AS [Extension]
    FROM dbo.voap_portalfilemanagement pfm
    WHERE
        pfm.voap_uploadtypename = 'Evidence'
        AND pfm.statuscodename != 'Complete'
        AND pfm.voap_filename LIKE '%.%'
)

SELECT *
FROM FileExtensions
WHERE
    LOWER([Extension]) != 'jpeg'
    AND PATINDEX('%[A-Z]%', [Extension]) > 0
ORDER BY [DateUploaded] DESC;
