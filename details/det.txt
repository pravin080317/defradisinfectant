{% assign pageNumber = request.querystring.page | default: 1 %}
{% assign bacode     = user.voap_contact_ActiveAccount_account.voa_bacodeacc %}

{% fetchxml reports %}
<fetch
  aggregate="true"
  version="1.0"
  output-format="xml-platform"
  mapping="logical"
  distinct="false"
  count="20"
  page="{{ pageNumber }}"
>
  <entity name="voap_portalrequest">
    <!-- 1. Group by the PK so each row stays unique -->
    <attribute name="voap_portalrequestid"                       alias="requestId"              groupby="true" />

    <!-- 2. Bring back your key fields by grouping them (one-to-one with the ID) -->
    <attribute name="voap_billingauthorityreportnumber"          alias="reportNumber"           groupby="true" />
    <attribute name="voap_billingauthorityreferencenumber"       alias="referenceNumber"        groupby="true" />
    <attribute name="voap_newpropertyaddressline5postcode"       alias="postcode"               groupby="true" />

    <!-- 3. Aggregate the date so we don’t have to “group” on a DateTime -->
    <attribute name="createdon"                                   alias="createdOn"              aggregate="max" />

    <filter type="and">
      <condition attribute="statuscode" operator="in">
        <value>400400001</value>
        <value>564100003</value>
      </condition>
      <condition attribute="voap_bacode"   operator="eq" value="{{ bacode }}" />
    </filter>

    <!-- 4. Attachments count in one join -->
    <link-entity
      name="voap_portalfilemanagement"
      from="voap_portalrequestlookup"
      to="voap_portalrequestid"
      alias="att"
      link-type="outer"
      aggregate="true"
    >
      <attribute
        name="voap_portalfilemanagementid"
        alias="supportingDocumentsCount"
        aggregate="countcolumn"
      />
      <filter type="and">
        <condition attribute="statuscode" operator="in">
          <value>695720002</value>
          <value>695720010</value>
          <value>695720003</value>
          <value>695720011</value>
          <value>695720007</value>
        </condition>
      </filter>
    </link-entity>

    <!-- 5. Sort by that aggregated date -->
    <order alias="createdOn" descending="true" />
  </entity>
</fetch>
{% endfetchxml %}
