Runbook: Schedules File Download Plugin

Overview

The Schedules File Download Plugin enables the downloading of schedule files from an external VOA storage system. It securely retrieves files based on user-selected criteria from PowerApps Portals, supporting multiple formats, such as HTML, XML, CSV, ASV, and ZIP. The plugin manages secure API authentication, structured file retrieval, and dynamic responses to user requests.

Execution Workflow

Plugin Invocation

Triggered when a user initiates a schedule file download request from PowerApps Portals.

Validates the plugin execution context and ensures parameters (filename, container, and storage account URL) are provided.

Retrieving API Credentials

Retrieves credentials securely from the voa_CredentialProvider custom Dataverse action.

Credentials include API base URL, Client ID, Client Secret, Scope, Subscription Key, and Tenant ID.

Authentication Generation

Generates an OAuth2 token using retrieved credentials for secure API requests.

Constructing and Sending API Request

Constructs an HTTP GET request to the external API for file retrieval:

https://voagw.npd.hmrc.gov.uk/dev/internal/bst/download-blob-file/download

Includes authentication headers:

Bearer token (Authorization header)

API Management subscription key (Ocp-Apim-Subscription-Key header)

Blob URL provided in the request headers

File Retrieval and Response

Retrieves file stream from the blob storage response.

Converts the file stream to Base64 encoded format for transfer.

Response Handling in Dataverse

Populates a Dataverse virtual entity (voap_downloadrequest) with file details:

MIME type

File content (Base64)

Download status (success or failure)

Error message (if applicable)

Returns the structured response to PowerApps Portals for file download.

API Endpoint

Endpoint:

https://voagw.npd.hmrc.gov.uk/dev/internal/bst/download-blob-file/download

Dataverse Virtual Table Used

Virtual Table Name

Description

Operation

voap_downloadrequest

Temporarily stores downloaded file data and metadata.

Insert/Update

Virtual Table Data Fields

Field Name

Description

voap_downloadrequestid

Unique identifier for the request.

voap_mimetype

MIME type of the downloaded file.

voap_filebinary

File content encoded in Base64.

voap_downloadstatus

Indicates success or failure.

voap_errormessage

Error message if download fails.

Logging and Traceability

The plugin uses Dataverse's TracingService to log:

API credential retrieval

OAuth2 authentication

API requests and file download responses

File conversion and storage status

Deployment & Maintenance

Configuration:

Verify secure credential storage in voa_CredentialProvider.

Confirm file retrieval parameters are correctly configured.

Routine Maintenance:

Regularly check API endpoint availability and token validity.

Monitor plugin logs for issues and timely resolution.

Conclusion

The Schedules File Download Plugin facilitates secure, efficient downloading of schedule files from external storage, ensuring seamless integration and user-friendly experiences through PowerApps Portals. Proper monitoring and regular maintenance are crucial for uninterrupted operation.

