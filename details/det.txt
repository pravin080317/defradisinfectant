SELECT
    -- File Management Details
    pfm.voap_portalfilemanagementid        AS PortalFileManagementId,
    pfm.voap_filename                      AS FileName,
    pfm.voap_filenameoriginal             AS OriginalFileName,
    pfm.statuscodename                   AS PortalFileStatus,
    pfm.createdon                        AS FileCreatedOn,
    pfm.createdbyname                    AS UploadedBy,
    pfm.voap_loggedinuser                AS LoggedInUser,
    pfm.voap_relatedbillingauthorityname AS CouncilName,
    pfm.voap_bacode                      AS BACode,
    pfm.voap_accountname                 AS AccountName,

    -- Portal Request Details
    pr.voap_portalrequestid              AS PortalRequestId,
    pr.voap_name                         AS PortalRequestName,
    pr.statuscodename                   AS PortalRequestStatus,
    pr.voap_billingauthorityreferencenumber AS CouncilReference,

    -- FrontDoor Processing Info
    fdr.voa_frontdoorrowid              AS FrontDoorRowId,
    fdr.statuscodename                 AS FrontDoorRowStatus,

    -- FrontDoor Error Details
    fde.voa_frontdoorerrorid           AS FrontDoorErrorId,
    fde.voa_error                      AS FrontDoorErrorCode,
    fde.voa_description               AS FrontDoorErrorDescription

FROM dbo.voap_portalfilemanagement pfm

-- Link Portal File Management → Portal Request
LEFT JOIN dbo.voap_portalrequest pr
    ON pr.voap_portalrequestid = pfm.voap_portalrequestlookup

-- Link Portal Request → FrontDoorRow
LEFT JOIN dbo.voa_frontdoorrow fdr
    ON fdr.voa_portalrequestid = pr.voap_portalrequestid

-- Link FrontDoorRow → FrontDoorError
LEFT JOIN dbo.voa_frontdoorerror fde
    ON fde.voa_frontdoorrowid = fdr.voa_frontdoorrowid

-- Filter PortalRequest statuses that are NOT in the excluded list
WHERE ISNULL(pr.statuscodename, '') NOT IN (
        'Validation and Address Matching Errors',
        'Ready to Submit with Address Matching Errors',
        'Submitted with Address Matching Errors',
        'Submitted'
    )

ORDER BY pfm.createdon DESC;
