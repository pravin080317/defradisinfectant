{% assign bacode = user.voap_contact_ActiveAccount_account.voa_bacodeacc %}
{% assign pageNumber = request.querystring.page | default: 1 %}

{% fetchxml reports %}
<fetch 
  version="1.0" 
  output-format="xml-platform" 
  mapping="logical" 
  distinct="false"
  count="20" 
  page="{{ pageNumber }}"
>
  <entity name="voap_portalrequest">
    <filter type="and">
      <condition attribute="statuscode" operator="in">
        <value>400400001</value>
        <value>564100003</value>
      </condition>
      <condition attribute="voap_bacode" operator="eq" value="{{ bacode }}" />
    </filter>

    <attribute name="voap_billingauthorityreportnumber" />
    <attribute name="voap_billingauthorityreferencenumber" />
    <attribute name="createdon" />
    <attribute name="voap_newpropertyaddressline5postcode" />
    <attribute name="voap_portalrequestid" />

    <link-entity 
      name="voap_portalfilemanagement" 
      from="voap_portalrequestlookup" 
      to="voap_portalrequestid" 
      alias="att" 
      link-type="outer" 
      aggregate="true"
    >
      <attribute 
        name="voap_portalfilemanagementid" 
        alias="supportingDocumentsCount" 
        aggregate="countcolumn" 
      />
      <filter type="and">
        <condition attribute="statuscode" operator="in">
          <value>695720002</value>
          <value>695720010</value>
          <value>695720003</value>
          <value>695720011</value>
          <value>695720007</value>
        </condition>
      </filter>
    </link-entity>

    <order attribute="createdon" descending="true" />
  </entity>
</fetch>
{% endfetchxml %}
