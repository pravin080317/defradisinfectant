SELECT
    -- File details
    pfm.voap_portalfilemanagementid        AS PortalFileManagementId,
    pfm.voap_filename                      AS FileName,
    pfm.voap_filenameoriginal             AS OriginalFileName,
    pfm.statuscodename                   AS FileStatus,
    pfm.createdon                        AS FileCreatedOn,

    -- User details
    pfm.createdbyname                    AS UploadedBy,
    pfm.voap_loggedinuser                AS LoggedInUser,

    -- Council details
    pfm.voap_relatedbillingauthorityname AS CouncilName,
    pfm.voap_bacode                      AS BACode,
    pfm.voap_accountname                 AS AccountName,

    -- Portal Request summary
    pr.voap_portalrequestid              AS PortalRequestId,
    pr.voap_name                         AS PortalRequestName,
    pr.statuscodename                   AS PortalRequestStatus,
    pr.createdon                        AS RequestCreatedOn

FROM dbo.voap_portalfilemanagement pfm

-- Join with portal request to see request-level info
LEFT JOIN dbo.voap_portalrequest pr
    ON pr.voap_portalrequestid = pfm.voap_portalrequestlookup

WHERE pfm.statuscodename = 'Processing'

ORDER BY pfm.createdon DESC;
