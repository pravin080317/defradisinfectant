let fullEvents = union
(
    customEvents
    | where name == "LAPortalLogin"
    | extend eventType = "Login",
             userId = tostring(customDimensions.userId),
             userCouncil = tostring(customDimensions.userCouncil),
             sessionId = tostring(customDimensions.sessionId),
             timestamp = timestamp
),
(
    pageViews
    | extend eventType = "PageView",
             userId = tostring(customDimensions.userId),
             userCouncil = tostring(customDimensions.userCouncil),
             sessionId = tostring(customDimensions.sessionId),
             timestamp = timestamp,
             pageName = name
)
| where userId != "Anonymous" and isnotempty(userCouncil) and userCouncil != "Unknown";

let councilSummary = fullEvents
| summarize councils = make_set(userCouncil), councilCount = dcount(userCouncil) by userId, sessionId;

fullEvents
| join kind=inner (councilSummary) on userId, sessionId
| project eventType, timestamp, userId, userCouncil, councilCount, councils, sessionId, pageName
| order by userId, sessionId, timestamp
