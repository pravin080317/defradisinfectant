Summary of Discussion: B2B Process for LA Portal
1. Current Guest User Onboarding (B2B Flow):
Users (e.g., Cognizant users) are added to the HMRC tenant as Azure AD guest users.

Once created, guest users are provided access to LA Portal via Access Packages.

A default email notification is triggered during guest user creation (HMRC plans to suppress or customize this email as it's not GDS-compliant or desirable for end-users at this stage).

2. Access Package & MyAccess Portal
Users typically use Microsoft's myaccess.microsoft.com to view available access packages, but HMRC has hidden these packages from general view.

Access packages can now only be assigned via direct URL, as per HMRC configuration.

Once access is approved (by someone like Stuart or Emma), users get application-level access (e.g., LA Portal).

3. Portal User Setup vs Manual B2B
The legacy "Canvas App" method still exists for creating guest users but is bypassed for bulk user uploads.

For private beta, a bulk upload mechanism is followed:

Bulk creation of guest users

Bulk assignment of access packages

Bypassing the manual Canvas App flow

4. Custom Portal Page for Approval (Day 2 Plan)
HMRC plans to introduce a custom-built admin page on the portal where internal users (e.g., Emma & Stuart) can manage user onboarding:

Fill in contact details

Select roles, accounts, councils

Trigger guest user creation and access package assignment via automation (avoiding myaccess.microsoft.com altogether).

5. Authentication Sync (Dataverse Contacts & Azure AD)
When a guest user logs in, the system automatically creates the external identity and web authentication records (in Dataverse) if they don’t already exist.

The system will map external users based on email matching, controlled via a site setting (Azure AD authentication: allow email mapping = yes).

6. Security Stamp Fix
Issue previously identified where contact records didn’t have a "security stamp" causing external identity linking failures.

Workaround: use "Change Password" on the contact record to auto-generate a security stamp (though this is being phased out with new automation).

7. Next Steps Identified
Suppress the default onboarding email.

Formalize the "custom portal user onboarding" process with automated guest user creation and access package assignment.

Ensure system syncs authentication records seamlessly using Graph API when needed.




JIRA SPIKE
Title:
Spike: Analysis and Design for Automated Guest User Onboarding for LA Portal (B2B Model)

Description:
This spike is to investigate, design, and recommend a solution for automating the onboarding process of external guest users (B2B users) into the HMRC Azure AD tenant and granting them secure access to the LA Portal.

The scope includes analyzing how to automate guest user creation, assigning access packages, suppressing default Azure AD onboarding emails, and automating contact and role assignment within Dataverse through a custom admin interface.

Acceptance Criteria:

Understand the current manual process (Canvas App + MyAccess portal + manual approvals).

Explore automation options via Microsoft Graph API for:

Guest user creation in Azure AD (HMRC tenant).

Access package assignment.

Integration with the portal user setup table and Dataverse contact records.

Evaluate how to suppress Azure AD invitation emails and replace with custom onboarding emails.

Define architecture & flow for onboarding via Power Pages / Power Apps admin interface.

Recommend an approach for handling single and multiple council/account associations.

Document dependencies (Azure AD, Dataverse, Power Automate, Azure Function, Graph API permissions, etc.).

Produce a high-level design with steps for implementation, automation flow, and security considerations.

Deliverables:

Design document outlining end-to-end automation.

List of required Azure resources (Graph API permissions, service principals, etc.).

High-level flow diagram for the onboarding process.

Recommendations on minimizing manual intervention and aligning with B2B onboarding best practices.

Target Outcome:
A clear design and implementation plan to automate the LA Portal guest user onboarding process aligned with HMRC's security model and user experience standards.
