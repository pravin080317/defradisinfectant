SELECT
    -- Portal Request Details
    pr.voap_portalrequestid                AS PortalRequestId,
    pr.voap_name                           AS PortalRequestName,
    pr.statuscodename                     AS PortalRequestStatus,
    pr.createdon                          AS RequestCreatedOn,
    pr.createdbyname                      AS RequestCreatedBy,
    pr.voap_billingauthorityreferencenumber AS CouncilReference,

    -- Portal File Management Details
    pfm.voap_portalfilemanagementid        AS PortalFileManagementId,
    pfm.voap_filename                      AS FileName,
    pfm.voap_filenameoriginal             AS OriginalFileName,
    pfm.statuscodename                   AS FileStatus,
    pfm.voap_loggedinuser                AS LoggedInUser,
    pfm.voap_relatedbillingauthorityname AS CouncilName,
    pfm.voap_bacode                      AS BACode,
    pfm.voap_accountname                 AS AccountName,

    -- FrontDoor Header Details (linked via PortalRequest)
    fdh.voa_frontdoorheaderid             AS FrontDoorHeaderId,
    fdh.voa_totalfrontdoorrowscount       AS TotalFrontDoorRows,
    fdh.voa_validatedfrontdoorrowcount    AS ValidatedRows,
    fdh.voa_unmatchedfrontdoorrowcount    AS UnmatchedRows,

    CASE 
        WHEN fdh.voa_frontdoorheaderid IS NOT NULL THEN 'Picked'
        ELSE 'Not Picked'
    END AS FrontDoorStatus,

    -- FrontDoor Row & Error Details
    fdr.voa_frontdoorrowid               AS FrontDoorRowId,
    fdr.statuscodename                  AS FrontDoorRowStatus,
    fde.voa_frontdoorerrorid            AS FrontDoorErrorId,
    fde.voa_error                       AS FrontDoorErrorCode,
    fde.voa_description                AS FrontDoorErrorDescription

FROM dbo.voap_portalrequest pr

-- Link PortalRequest → PortalFileManagement
LEFT JOIN dbo.voap_portalfilemanagement pfm
    ON pr.voap_portalrequestid = pfm.voap_portalrequestlookup

-- Link PortalRequest → FrontDoorHeader (new join path)
LEFT JOIN dbo.voa_frontdoorheader fdh
    ON fdh.voa_submissionid = pr.voap_portalrequestid

-- Link FrontDoorHeader → FrontDoorRow
LEFT JOIN dbo.voa_frontdoorrow fdr
    ON fdr.voa_frontdoorheaderid = fdh.voa_frontdoorheaderid

-- Link FrontDoorRow → FrontDoorError
LEFT JOIN dbo.voa_frontdoorerror fde
    ON fde.voa_frontdoorrowid = fdr.voa_frontdoorrowid

-- Exclude processed statuses
WHERE ISNULL(pr.statuscodename, '') NOT IN (
        'Validation and Address Matching Errors',
        'Ready to Submit with Address Matching Errors',
        'Submitted with Address Matching Errors',
        'Submitted'
    )

ORDER BY pr.createdon DESC;
