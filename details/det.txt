// Step 1: Get login events
customEvents
| where name == "LAPortalLogin"
| extend
    userId = tostring(customDimensions.userId),
    userName = tostring(customDimensions.userName),
    userCouncil = tostring(customDimensions.userCouncil),
    sessionId = tostring(customDimensions.sessionId),
    loginTime = todatetime(customDimensions.loginTime),
    eventType = "Login",
    switchTime = datetime(null),
    switchCouncil = ""
| project timestamp, eventType, userId, userName, sessionId, loginTime, switchTime, userCouncil, switchCouncil

// Step 2: Get CouncilSwitched events
| union (
    customEvents
    | where name == "CouncilSwitched"
    | extend
        userId = tostring(customDimensions.userId),
        userName = tostring(customDimensions.userName),
        sessionId = tostring(customDimensions.sessionId),
        switchCouncil = tostring(customDimensions.userCouncil),
        previousCouncil = tostring(customDimensions.previousCouncil),
        switchTime = timestamp,
        eventType = "CouncilSwitch"
    | project timestamp, eventType, userId, userName, sessionId, loginTime = datetime(null), switchTime, userCouncil = previousCouncil, switchCouncil
)

// Step 3: Summarize for each session
| summarize 
    loginTime = minif(timestamp, eventType == "Login"),
    switchEvents = make_list(pack("switchTime", switchTime, "from", userCouncil, "to", switchCouncil)),
    totalCouncils = dcountif(switchCouncil, switchCouncil != "" and isnotempty(switchCouncil)) + 1,
    userName = any(userName)
    by userId, sessionId
| order by loginTime desc
