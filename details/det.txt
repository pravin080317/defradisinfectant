SELECT 
    pfm.voap_portalfilemanagementid        AS PortalFileManagementId,
    pfm.voap_filename                      AS FileName,
    pfm.statuscodename                    AS FileStatus,
    pfm.createdon                         AS FileCreatedOn,
    pfm.createdbyname                     AS UploadedBy,
    pfm.voap_billingauthority             AS BillingAuthorityId,
    pfm.voap_billingauthorityname         AS BillingAuthorityName,
    pfm.voap_bacode                       AS BACode,
    pfm.voap_accountname                  AS AccountName,

    -- Front Door Header info
    fdh.voa_frontdoorheaderid             AS FrontDoorHeaderId,
    fdh.voa_totalfrontdoorrowscount       AS TotalRows,
    fdh.voa_validatedfrontdoorrowcount    AS ValidatedRows,
    fdh.voa_unmatchedfrontdoorrowcount    AS UnmatchedRows,
    fdh.voa_addressmatchfrontdoorrowcount AS AddressMatchedRows,

    -- Front Door Row details
    fdr.voa_frontdoorrowid                AS FrontDoorRowId,
    fdr.statuscodename                   AS RowStatus,
    fdr.voa_name                         AS RowName,
    fdr.voa_reference                    AS RowReference,
    fdr.voa_numberofunmatchedaddresses   AS UnmatchedAddressCount,

    -- Front Door Errors
    fde.voa_frontdoorerrorid             AS FrontDoorErrorId,
    fde.voa_error                        AS ErrorMessage,
    fde.voa_description                 AS ErrorDescription

FROM dbo.voap_portalfilemanagement pfm
LEFT JOIN dbo.voa_frontdoorheader fdh
    ON fdh.voa_portalfilemanagementid = pfm.voap_portalfilemanagementid
LEFT JOIN dbo.voa_frontdoorrow fdr
    ON fdr.voa_frontdoorheaderid = fdh.voa_frontdoorheaderid
LEFT JOIN dbo.voa_frontdoorerror fde
    ON fde.voa_frontdoorrowid = fdr.voa_frontdoorrowid

WHERE pfm.statuscodename IN ('Processing', 'Processing Error', 'New')
  AND pfm.createdon <= DATEADD(DAY, -2, GETDATE())

ORDER BY pfm.createdon ASC;
