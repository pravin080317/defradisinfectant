SELECT
    pfm.voap_portalfilemanagementid        AS PortalFileManagementId,
    pfm.voap_filename                     AS FileName,
    pfm.voap_filenameoriginal             AS OriginalFileName,
    pfm.statuscodename                   AS FileStatus,
    pfm.createdon                        AS FileCreatedOn,
    pfm.createdbyname                    AS UploadedBy,
    pfm.voap_loggedinuser                AS LoggedInUser,
    pfm.voap_billingauthority            AS BillingAuthorityId,
    pfm.voap_relatedbillingauthorityname AS BillingAuthorityName,  -- ✅ Corrected column name
    pfm.voap_bacode                      AS BACode,
    pfm.voap_accountname                 AS AccountName,

    -- Portal Request info
    pr.voap_portalrequestid              AS PortalRequestId,
    pr.voap_name                         AS PortalRequestName,
    pr.createdon                         AS RequestCreatedOn,
    pr.statuscodename                   AS PortalRequestStatus,

    -- Check if frontdoor header has picked it
    CASE 
        WHEN fdh.voa_frontdoorheaderid IS NOT NULL THEN 'Picked'
        ELSE 'Not Picked'
    END AS FrontDoorStatus,

    fdh.voa_frontdoorheaderid           AS FrontDoorHeaderId,
    fdh.voa_totalfrontdoorrowscount     AS TotalFrontDoorRows,
    fdh.voa_validatedfrontdoorrowcount  AS ValidatedRows,         -- ✅ Confirmed column name
    fdh.voa_unmatchedfrontdoorrowcount  AS UnmatchedRows          -- ✅ Confirmed column name

FROM dbo.voap_portalfilemanagement pfm
LEFT JOIN dbo.voap_portalrequest pr
    ON pr.voap_portalrequestid = pfm.voap_portalrequestlookup   -- ✅ Correct relationship field
LEFT JOIN dbo.voa_frontdoorheader fdh
    ON fdh.voa_portalfilemanagementid = pfm.voap_portalfilemanagementid  -- ✅ Correct mapping

WHERE pfm.statuscodename = 'New'
  AND pfm.createdon <= DATEADD(HOUR, -24, GETDATE())

ORDER BY pfm.createdon ASC;
